{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "EmailAction",
  "type": "object",
  "additionalProperties": false,
  "required": ["type", "id", "headers", "body"],
  "properties": {
    "type": {
      "const": "email",
      "description": "Must be 'email'."
    },
    "id": {
      "type": "string",
      "minLength": 1,
      "pattern": "^[A-Za-z_][A-Za-z0-9_]*$",
      "description": "Logical identifier for this email action."
    },
    "description": {
      "type": "string"
    },

    "headers": {
      "type": "object",
      "additionalProperties": false,
      "required": ["from", "to", "subject"],
      "properties": {
        "from": { "$ref": "#/$defs/EmailAddressOrExpr" },
        "to": { "$ref": "#/$defs/RecipientOrExpr" },
        "cc": { "$ref": "#/$defs/RecipientOrExpr" },
        "bcc": { "$ref": "#/$defs/RecipientOrExpr" },
        "replyTo": { "$ref": "#/$defs/EmailAddressOrExpr" },

        "subject": { "$ref": "#/$defs/NonEmptyStringOrExpr" },

        "headers": {
          "type": "object",
          "description": "Optional extra mail headers (e.g., X-Correlation-Id). Values may be literal strings or expressions.",
          "propertyNames": { "$ref": "#/$defs/HeaderName" },
          "additionalProperties": { "$ref": "#/$defs/NonEmptyStringOrExpr" }
        }
      }
    },

    "body": {
      "type": "object",
      "additionalProperties": false,
      "required": ["templateRef", "parameters"],
      "properties": {
        "templateRef": {
          "type": "string",
          "minLength": 1,
          "pattern": "^.+\\.ftl$",
          "description": "Name/path of the FreeMarker (FTL) template."
        },
        "parameters": {
          "type": "object",
          "description": "Variables passed into the template. Keys must be identifier-like. Values may be literal or expressions.",
          "propertyNames": { "$ref": "#/$defs/Identifier" },
          "additionalProperties": { "$ref": "#/$defs/NonEmptyStringOrExpr" }
        }
      }
    }
  },

  "$defs": {
    "Identifier": {
      "type": "string",
      "minLength": 1,
      "pattern": "^[A-Za-z_][A-Za-z0-9_]*$"
    },

    "HeaderName": {
      "type": "string",
      "minLength": 1,
      "pattern": "^[A-Za-z0-9-]+$"
    },

    "Expression": {
      "type": "string",
      "pattern": "^\\$\\{~[^}]+~\\}$",
      "description": "Expression placeholder in the form ${~ ... ~}."
    },

    "NonEmptyString": {
      "type": "string",
      "minLength": 1
    },

    "NonEmptyStringOrExpr": {
      "description": "Either a non-empty literal string or an expression placeholder.",
      "anyOf": [
        { "$ref": "#/$defs/Expression" },
        { "$ref": "#/$defs/NonEmptyString" }
      ]
    },

    "EmailAddressLiteral": {
      "type": "string",
      "minLength": 3,
      "pattern": "^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$",
      "description": "Literal email address (local@domain.tld)."
    },

    "EmailAddressOrExpr": {
      "description": "Either a literal email address or an expression placeholder.",
      "anyOf": [
        { "$ref": "#/$defs/Expression" },
        { "$ref": "#/$defs/EmailAddressLiteral" }
      ]
    },

    "RecipientOrExpr": {
      "description": "Recipient(s) as a single value or list; each may be literal or expression.",
      "anyOf": [
        { "$ref": "#/$defs/EmailAddressOrExpr" },
        {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/EmailAddressOrExpr" }
        }
      ]
    }
  }
}